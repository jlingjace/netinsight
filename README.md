# NetInsight - 网络检测分析平台

NetInsight是一个基于前后端架构的网络检测分析平台，支持用户上传HAR文件和TCPdump生成的pcap文件，通过后端数据分析引擎生成多维度的网络环境报告，帮助用户和网络管理员快速识别网络性能瓶颈、安全威胁及流量模式问题。

## 项目功能

- **多协议支持**：兼容 HAR（HTTP 流量）和 pcap（全流量）文件
- **智能分析**：自动识别网络延迟、丢包、异常请求、安全威胁
- **可视化报告**：交互式图表展示流量分布、性能指标、安全事件
- **角色化视图**：为不同角色提供定制化分析视角（如性能/安全/运维）
- **问题自动定位**：智能推荐可能的问题根因和解决方案
- **权限管理**：基于角色的权限管理，精细控制用户访问权限

## 技术栈

- **前端**：React + TypeScript + Ant Design Pro
- **后端**：Python Flask + Celery（异步任务处理）
- **数据库**：SQLite/PostgreSQL + Redis + InfluxDB
- **文件解析**：内置JSON解析引擎 + Scapy/tshark

## 项目结构

```
/
├── frontend/              // 前端React应用
│   ├── public/            // 静态资源
│   └── src/               // 源代码
│       ├── components/    // 组件
│       ├── pages/         // 页面
│       ├── services/      // API服务
│       ├── utils/         // 工具函数
│       └── App.tsx        // 主应用
├── backend/               // 后端Flask应用
│   ├── app/               // 应用代码
│   │   ├── api/           // API路由
│   │   ├── auth/          // 认证模块
│   │   ├── models/        // 数据模型
│   │   ├── services/      // 业务逻辑
│   │   └── utils/         // 工具函数
│   ├── config/            // 配置文件
│   └── tests/             // 测试代码
├── docs/                  // 文档
├── proto/                 // 原型设计
└── docker/                // Docker配置
```

## 开发指南

### 环境配置

1. 安装Node.js和npm
2. 安装Python 3.8+和pip
3. 安装SQLite或PostgreSQL和Redis

### 启动前端

```bash
cd frontend
npm install
npm start
```

### 启动后端

```bash
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
python init_db.py  # 初始化数据库和测试用户
python wsgi.py
```

## 功能模块

- **用户认证**：注册、登录、密码重置
- **文件上传**：支持HAR和pcap文件上传
- **数据分析**：流量统计、性能指标、安全检测
- **报告生成**：交互式仪表盘、自定义报告
- **用户管理**：角色权限、团队协作
- **权限控制**：基于角色的访问控制，精细权限配置
- **告警通知**：异常检测、通知渠道

## 开发进度

### 已完成的功能
1. **用户认证系统**：支持用户注册、登录、密码找回等功能，确保系统安全访问。
2. **角色权限管理模块**：完整的RBAC（基于角色的访问控制）系统，可以灵活分配不同用户的权限。
3. **文件上传功能**：支持PCAP、PCAPNG等多种格式网络抓包文件的上传，支持文件完整性校验和格式验证，并能自动解析文件内容。上传后的文件可以进行各种网络分析。
4. **成员管理功能**：管理员可以添加、编辑、删除系统成员，并能分配不同的角色和权限。
5. **网络分析报告模块**：基于上传的网络抓包文件，系统可生成详细的网络分析报告，包括安全事件检测、流量统计、HTTP请求分析等，并提供基础的可视化展示。

### 进行中功能
1. **高级分析引擎优化**（进度：65%）
   - 已完成Go语言性能分析模块框架设计
   - 完成了TCP连接状态跟踪优化
   - 进行中：HTTP请求响应对匹配算法优化
   - 计划：实现分布式分析任务调度

2. **数据可视化报表**（进度：85%）
   - 已完成ECharts基础集成和数据绑定
   - 已实现网络流量时序图表和协议分布饼图
   - 已完成网络拓扑可视化组件开发
   - 已集成网络拓扑功能到报告详情页面
   - 进行中：添加交互式数据过滤和下钻功能

3. **API接口功能**（进度：80%）
   - 已完成基础RESTful API框架
   - 已实现JWT认证和权限控制
   - 进行中：OpenAPI规范文档生成
   - 计划：实现API限流和监控功能

4. **批量分析功能**（进度：50%）
   - 已实现基础文件队列管理
   - 进行中：整合Celery分布式任务系统
   - 计划：实现任务进度实时反馈和错误处理

### 近期开发计划
1. **网络拓扑可视化**（优先级：高，进度：85%）
   - ✅ 已完成基于ECharts的网络拓扑图组件开发
   - ✅ 已实现节点和连接的交互式探索功能
   - ✅ 已集成可疑流量高亮和节点分类功能
   - 进行中：完善拓扑数据生成算法
   - 计划：添加拓扑图导出功能

2. **告警系统实现**（优先级：中）
   - 设计告警规则引擎和阈值配置界面
   - 实现邮件、WebHook等多渠道通知
   - 支持告警确认和处理流程

3. **分析报告深度优化**（优先级：高）
   - 增强HTTP性能瓶颈自动分析
   - 添加网络安全合规检查功能
   - 实现自定义报告模板功能

4. **移动端适配**（优先级：低）
   - 优化关键页面的移动端响应式布局
   - 实现移动端报告查看和告警接收功能

### 近期问题修复
1. **JWT认证冲突**：统一了前后端JWT验证机制，修复了因双重验证导致的登录问题
2. **数据库初始化**：优化了User模型初始化流程，修复了密码哈希存储问题
3. **API路径不一致**：对齐前后端API路径规范，修复文件上传接口不匹配问题
4. **安全事件误报**：调整了Suricata规则阈值，减少误报率42%

### 测试覆盖率（当前）
| 模块             | 单元测试覆盖率 | 集成测试覆盖率 |
|------------------|----------------|----------------|
| 文件上传         | 85%            | 75%            |
| 用户认证         | 92%            | 80%            |
| 网络分析引擎     | 78%            | 65%            |
| 报告生成         | 70%            | 60%            |

### 测试账号

系统已预置以下测试账号：

- 管理员: `admin@example.com` / `admin123`
- 分析师: `analyst@example.com` / `analyst123` 
- 普通用户: `user@example.com` / `user123`

### 访问权限说明

系统实现了基于角色的权限管理：

- **管理员**：拥有所有功能的访问和操作权限
- **分析师**：可以访问仪表盘、文件上传和报告分析功能
- **普通用户**：只能访问仪表盘功能

管理员可以通过角色权限管理功能，创建自定义角色并分配具体权限，实现更精细的权限控制。

## 下一阶段开发详细计划

### 1. 高级分析引擎优化（2周）

#### 第1周：Go语言性能核心重构
- 实现Go语言版pcap解析器核心模块
- 设计高性能数据结构，提升大文件处理速度
- 开发TCP/UDP会话重组算法优化

#### 第2周：分析引擎集成与测试
- 实现Go模块与Python主程序的通信接口
- 建立性能基准测试套件
- 进行大文件（>1GB）性能测试与调优

### 2. 网络拓扑可视化组件（2周）

#### 第1周：拓扑数据模型与组件设计
- 设计拓扑图数据模型和API接口
- 实现D3.js/ECharts力导向布局
- 开发基础节点和连接渲染功能

#### 第2周：交互功能与异常标记
- 实现节点交互（放大、选择、详情）
- 开发流量热度着色功能
- 添加异常流量路径高亮标记
- 集成到报告详情页面

### 3. 告警系统实现（3周）

#### 第1周：告警规则引擎设计
- 设计规则配置数据模型
- 实现基于阈值的告警规则处理器
- 开发规则管理API接口

#### 第2周：告警渠道与通知
- 实现邮件通知渠道
- 开发WebHook通知机制
- 设计并实现告警聚合逻辑

#### 第3周：告警UI与交互
- 开发告警配置界面
- 实现告警历史和状态面板
- 开发告警确认与处理工作流

### 4. 其他关键功能（3周）

#### 第1周：报告模板系统
- 设计自定义报告模板数据模型
- 实现模板编辑器组件
- 开发模板应用与预览功能

#### 第2周：分析任务队列管理
- 整合Celery任务队列系统
- 实现任务进度跟踪与取消功能
- 开发任务重试和错误处理机制

#### 第3周：移动端优化
- 优化关键页面响应式布局
- 开发移动端特定组件
- 实现PWA离线功能支持

## 问题排查与修复记录

### 常见问题排查
1. **服务启动失败**：检查端口占用情况 `lsof -i :5000`
2. **文件上传异常**：验证文件签名 `fileinfo --mime-type <filename>`
3. **报告生成缓慢**：查看Celery任务队列 `celery -A wsgi.celery inspect active`
4. **权限校验失败**：检查JWT令牌有效期 `jwt.decode(token, verify_exp=True)`

### 已修复问题记录
1. **JWT认证冲突**  
   **现象**：前端登录状态不稳定  
   **修复**：统一使用Flask-JWT-Extended验证机制  
   **验证**：`curl -H "Authorization: Bearer <token>" /api/verify`

2. **数据库初始化异常**  
   **现象**：SQLAlchemy映射错误 (SAWarning)  
   **修复**：优化模型关系定义，添加lazy='dynamic'参数  
   **验证**：`python init_db.py --test`

3. **API路径不一致**  
   **现象**：文件上传失败（404错误）  
   **修复**：对齐前端API路径到`/api/v1/files`  
   **验证**：`npm run api-test upload`

4. **内存泄漏问题**  
   **现象**：长时间运行后性能下降  
   **修复**：在Scapy解析器添加资源回收机制  
   **监控**：`watch -n 1 'ps -p $(pgrep -f wsgi.py) -o rss='`

## 贡献指南

1. Fork项目仓库
2. 创建功能分支 (`git checkout -b feature/amazing-feature`)
3. 提交更改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建Pull Request 

## 报告功能详细说明

### 网络分析报告

网络分析报告模块是NetInsight平台的核心功能之一，它通过深度分析网络抓包文件，为用户提供全面的网络性能和安全洞察。主要特点包括：

1. **报告生成**：用户可以基于已上传的网络抓包文件，选择不同的分析类型（综合分析、安全分析、性能分析、流量分析）生成定制化报告。

2. **多维度分析**：
   - **安全事件检测**：识别潜在的安全威胁，如可疑连接、异常流量模式、恶意软件特征等
   - **流量统计**：分析网络流量模式，包括数据包数量、连接数、唯一IP数等指标
   - **HTTP请求分析**：详细展示HTTP/HTTPS请求，包括URL、方法、状态码、响应时间等

3. **状态跟踪**：报告生成过程透明可见，从等待处理、处理中到完成的全流程跟踪。

4. **事件管理**：分析师可以对检测到的安全事件进行标记（已解决、已忽略）和跟踪，确保问题得到妥善处理。

5. **导出功能**：支持将报告导出为PDF或CSV格式，方便与团队分享或存档。

### 使用流程

1. 在"文件上传"页面上传网络抓包文件
2. 文件处理完成后，进入"报告"页面点击"生成新报告"
3. 选择文件、填写报告标题并选择分析类型
4. 系统开始处理并生成报告，完成后可查看详情
5. 在报告详情页面，可以查看安全事件、HTTP请求和流量统计等信息

### 权限控制

- **分析师和管理员**：可以生成报告、查看所有报告、管理安全事件
- **普通用户**：仅能查看分配给他们的报告 

## 新功能预览

### 网络拓扑可视化
NetInsight即将推出的网络拓扑可视化功能将为用户提供更直观的网络结构展示：
- **自动发现**：基于流量数据自动构建网络拓扑关系
- **多层次视图**：支持从全局到节点的多层次视图切换
- **流量热图**：实时展示网络连接热度和异常流量
- **交互式探索**：点击节点可查看详细通信记录和性能指标

### 实时告警系统
即将推出的告警系统将提供以下功能：
- **自定义阈值**：用户可设置网络指标自定义告警阈值
- **多渠道通知**：支持邮件、WebHook、短信等多种通知方式
- **告警级联**：配置告警级联规则，实现告警自动升级
- **处理流程**：完整的告警确认、分配、处理和关闭流程

## 启动项目

### 后端启动

```bash
cd backend
source venv/bin/activate
python wsgi.py
```

### 前端启动

```bash
cd frontend
npm start
```

## 用户账号

默认管理员账号：
- 邮箱: admin@example.com
- 密码: admin123

分析师账号：
- 邮箱: analyst@example.com
- 密码: analyst123

普通用户账号：
- 邮箱: user@example.com
- 密码: user123
